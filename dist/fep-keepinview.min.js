/*! fep-keepinview - v1.0.0-alpha - 2013-12-18
* https://github.com/dutchcelt/fep-keepinview
* Copyright (c) 2013 Egor Kloos; Licensed GPL v3 */
(function(t){"function"==typeof define&&define.amd?define(["FEP-KeepInView"],t):t(window)})(function(){window.FEP=window.FEP||{},FEP.KeepInView=function(t,i,s){var o=Object.create(FEP.KeepInView.object);if(o.options=Object.create(o.defaults),"object"==typeof i)for(var n in i)o.options[n]=i[n];return e(t).forEach(function(t){var e=Object.create(o);e.stickyElem=t,e.index=FEP.KeepInView.object.index++,e.init(s)})};var t=function(t,e){var i;try{i=new CustomEvent(t,{bubbles:!0,cancelable:!0,returnValue:!1,detail:e})}catch(s){i=document.createEvent("CustomEvent"),i.initCustomEvent(t,!0,!0,e)}finally{return i}},e=function(t,e){return Array.prototype.slice.call((e||document).querySelectorAll(t))},i=function(t){var e=RegExp("(?:^|\\s)"+t+"(?!\\S)","g");return e},s=function(t,s){e("."+t,s).forEach(function(e){e.className=e.className.replace(i(t),"")})},o=function(t,e){i(e).test(t.className)||(t.className+=(""===t.className?"":" ")+e)},n=function(t,e){for(var i in e)t.style[i]=e[i]};FEP.KeepInView.object={namespace:"kiv",ticking:!1,index:0,defaults:{fixed:!1,edgeOffset:0,zindex:"auto",customClass:!1,trigger:"both",scrollable:!1,h:0,w:0,offsetAnchor:!1,cloned:!1},options:{},box:{},toggleElem:function(){return this.box.height>window.innerHeight&&!this.options.scrollable||this.options.fixed?!1:(this.elem.scrolledOutAt=!1,this.box.top=!this.box.top||this.options.edgeOffset,"bottom"!==this.options.trigger&&this.elem.boundry.topOffset-this.options.edgeOffset<window.pageYOffset&&(this.elem.scrolledOutAt="top"),"top"!==this.options.trigger&&window.innerHeight<=this.box.bottom&&(this.elem.scrolledOutAt="bottom"),this.options.customClass?this.options.customClass&&("both"===this.options.trigger?"bottom"===scrolledOutAt||"top"===scrolledOutAt?o(this.elem,this.options.customClass+"-"+scrolledOutAt):scrolledOutAt||(s(this.options.customClass+"-top",this.elem),s(this.options.customClass+"-bottom",this.elem)):scrolledOutAt===this.options.trigger?o(this.elem,this.options.customClass+"-"+this.options.trigger):scrolledOutAt||s(this.options.customClass+"-"+this.options.trigger,this.elem)):this.elem.scrolledOutAt!==!1?this.elem.isSticky||(this.elem.style.position="fixed",this.elem.style.display=this.elem.orginalRenderedState.display,this.elem.style[this.elem.scrolledOutAt]=this.elem.boundry[this.elem.scrolledOutAt],this.options.scrollable&&(this.elem.style.top=this.box.top+"px",this.elem.style.height=window.innerHeight-this.box.top+"px"),this.elem.isSticky=!0):this.elem.isSticky?(this.elem.style.position=this.elem.orginalRenderedState.position,this.elem.style.display=this.options.cloned?"none":this.elem.orginalRenderedState.display,this.elem.isSticky=!1):this.options.scrollable&&(this.elem.style.height=window.innerHeight-this.box.top+"px"),this.ticking=!1,void 0)},getDimensions:function(t){t=t||this.stickyElem.getBoundingClientRect();var e={};for(var i in t)e[i]=t[i];return e},getDimOffset:function(t){var e=new Number(getComputedStyle(this.elem)[t].replace(/\D+$/,"")).valueOf();return e},renderObject:function(){var t=this.getDimOffset("marginTop"),e=this.getDimOffset("marginBottom"),i=this.getDimOffset("marginLeft"),s=window.pageXOffset,o=window.pageYOffset;window.scroll(0,0),this.elem.style.width=null,this.box=this.getDimensions(),this.elem.boundry={zIndex:this.options.zindex,display:getComputedStyle(this.elem).display,position:this.options.cloned?"fixed":this.elem.orginalRenderedState.position,overflow:this.options.scrollable?"auto":"visible",left:this.box.left-i+"px",width:this.box.width+"px"},this.options.fixed?(this.elem.isSticky=!0,this.elem.boundry.position="fixed",this.elem.boundry.top=this.options.edgeOffset+t+"px"):(this.options.scrollable?(this.elem.style.height=window.innerHeight-this.box.top-this.options.edgeOffset+"px",this.elem.boundry.top=this.box.top+t+"px"):this.elem.boundry.height=this.box.height+"px",this.elem.boundry.width=this.box.width+"px"),n(this.elem,this.elem.boundry),this.anchorShifter(),this.elem.boundry.top=this.options.edgeOffset+t+"px",this.elem.boundry.bottom=this.options.edgeOffset+e+"px",this.elem.boundry.topOffset=this.box.top+t,this.elem.boundry.bottomOffset=this.box.bottom+e,window.scroll(s,o)},update:t("update"),unstick:t("unstick"),set:t("set"),stickyFunction:function(t){t?(this.elem.isSticky=!1,this.renderObject()):this.box=this.getDimensions(),this.ticking||(requestAnimationFrame(this.toggleElem.bind(this)),this.ticking=!0)},killSticky:function(){this.elem.removeEventListener("update",this,!0),this.elem.removeEventListener("set",this,!0),this.elem.removeAttribute("style"),this.elem.isSticky=!1},handleEvent:function(t){switch(t.preventDefault(),t.type){case"update":this.stickyFunction(!0);break;case"set":this.stickyFunction(!1);break;case"unstick":this.killSticky();break;case"resize":this.elem.dispatchEvent(this.update);break;case"scroll":this.elem.dispatchEvent(this.set)}},anchorShifter:function(){if(this.options.offsetAnchor){var t,i=this,s=e("a[name]",this.stickyElem.parentNode),o=function(){var e=+new Date;do t=s.shift(),n(t,{position:"relative",display:"block",top:"-"+i.box.height+"px"});while(void 0!==s[0]&&50>+new Date-e);void 0!==s[0]&&setTimeout(o,0)};o()}},init:function(t){this.options.cloned?(this.elem=this.stickyElem.cloneNode(!0),this.stickyElem.parentNode.insertBefore(this.elem,this.stickyElem),o(this.elem,this.namespace+"-cloned"),o(this.stickyElem,this.namespace+"-original"),this.elem.style.display="none"):this.elem=this.stickyElem,this.elem.orginalRenderedState={position:getComputedStyle(this.stickyElem).position,display:getComputedStyle(this.stickyElem).display},o(this.elem,this.namespace+"-"+this.index),this.elem.addEventListener("update",this,!0),this.elem.addEventListener("unstick",this,!0),this.elem.addEventListener("set",this,!0),window.addEventListener("resize",this,!0),window.addEventListener("scroll",this,!0),this.elem.dispatchEvent(this.update),"function"==typeof t&&t(this)}},FEP.KeepInView.unstick=FEP.KeepInView.object.unstick});