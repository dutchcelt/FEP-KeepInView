/*! fep-keepinview - v1.0.0-alpha - 2013-12-12
* https://github.com/dutchcelt/fep-keepinview
* Copyright (c) 2013 Egor Kloos; Licensed GPL v3 */
(function(t){"function"==typeof define&&define.amd?define(["FEP-KeepInView"],t):t(window)})(function(){window.FEP=window.FEP||{},FEP.KeepInView=function(t,i,s){var o=Object.create(FEP.KeepInView.object);if(o.options=Object.create(o.defaults),"object"==typeof i)for(var n in i)o.options[n]=i[n];return e(t).forEach(function(t){var e=Object.create(o);e.stickyElem=t,e.index=FEP.KeepInView.object.index++,e.init(s)})};var t=function(t,e){var i;try{i=new CustomEvent(t,{bubbles:!0,cancelable:!0,returnValue:!1,detail:e})}catch(s){i=document.createEvent("CustomEvent"),i.initCustomEvent(t,!0,!0,e)}finally{return i}},e=function(t,e){return Array.prototype.slice.call((e||document).querySelectorAll(t))},i=function(t){var e=RegExp("(?:^|\\s)"+t+"(?!\\S)","g");return e},s=function(t,s){e("."+t,s).forEach(function(e){e.className=e.className.replace(i(t),"")})},o=function(t,e){i(e).test(t.className)||(t.className+=" "+e)},n=function(t){t=t||this.stickyElem.getBoundingClientRect();var e={};for(var i in t)e[i]=Math.round(t[i]),"top"===i&&(e[i]=e[i]-(parseInt(getComputedStyle(this.stickyElem).marginTop)||0)),"left"===i&&(e[i]=e[i]-(parseInt(getComputedStyle(this.stickyElem).marginLeft)||0));return e},h=function(t,e){for(var i in e)t.style[i]=e[i]};FEP.KeepInView.update=t("update"),FEP.KeepInView.unstick=t("unstick"),FEP.KeepInView.set=t("set"),FEP.KeepInView.object={namespace:"KIV",ticking:!1,index:0,$elem:null,$parent:null,defaults:{fixed:!1,edgeOffset:0,zindex:"auto",customClass:!1,trigger:"both",scrollable:!1,h:0,w:0,offsetAnchor:!1,cloned:!1},options:{},setElem:function(){if(this.stickyElem.offsetHeight>window.innerHeight&&!this.options.scrollable)return!1;this.options.clearStyle&&this.elem.removeAttribute("style");var t="",e=window.innerHeight;this.box.height,parseInt(this.box.top+this.box.height-Math.abs(window.pageYOffset)+this.options.edgeOffset,10)>e&&!this.options.fixed&&(t="bottom"),window.pageYOffset>this.box.top-this.options.edgeOffset&&!this.options.fixed&&(t="top"),this.options.customClass?this.options.customClass&&("both"===this.options.trigger?"bottom"===t||"top"===t?o(this.elem,this.options.customClass+"-"+t):t||(s(this.options.customClass+"-top",this.elem),s(this.options.customClass+"-bottom",this.elem)):t===this.options.trigger?o(this.elem,this.options.customClass+"-"+this.options.trigger):t||s(this.options.customClass+"-"+this.options.trigger,this.elem)):(this.options.scrollable?this.prepCSS({height:e-this.box.top+"px",overflow:"auto"}):this.prepCSS(),"bottom"!==t||"both"!==this.options.trigger&&"bottom"!==this.options.trigger?"top"!==t||"both"!==this.options.trigger&&"top"!==this.options.trigger?this.options.fixed?h(this.elem,{top:this.options.edgeOffset+"px",left:this.box.left,height:"auto"}):this.options.scrollable?h(this.elem,{position:this.position,top:this.box.top+"px",height:e-this.box.top+window.pageYOffset+"px"}):this.options.offsetAnchor?(h(this.stickyElem,{visibility:"visible"}),h(this.elem,{display:"none"})):this.elem.removeAttribute("style"):this.options.scrollable?this.prepCSS({height:e+"px",top:this.options.edgeOffset+"px",overflow:"auto"}):this.fixCSS(this.options.edgeOffset):this.options.scrollable?this.prepCSS({height:e+"px",top:e-this.box.height-this.options.edgeOffset+"px",overflow:"auto"}):this.fixCSS(e-this.box.height-this.options.edgeOffset)),this.ticking=!1},cssObject:function(){return{position:"fixed",left:this.box.left+"px",width:this.options.scrollable?this.box.width-15+"px":this.box.width+"px",height:this.options.scrollable?window.innerHeight-this.box.top+"px":this.box.height+"px",zIndex:this.options.zindex}},prepCSS:function(t){cssObj=Object.create(this.cssObject.call(this));for(var e in t)cssObj[e]=t[e];h(this.elem,cssObj)},fixCSS:function(t){this.elem.style.top=t+"px",this.options.offsetAnchor&&(this.stickyElem.style.visibility="hidden",this.elem.style.display="block")},staySticky:function(t){t.preventDefault(),this.box=n.call(this,t.target.getBoundingClientRect()),this.options.clearStyle=!0,this.ticking||requestAnimationFrame(this.setElem.bind(this)),this.ticking=!0},setElemRequest:function(t){t.preventDefault(),this.options.clearStyle=!1,this.ticking||requestAnimationFrame(this.setElem.bind(this)),this.ticking=!0},killSticky:function(){var t=this.elem.cloneNode(!0);t.removeAttribute("style"),this.elem.parentNode.replaceChild(t,this.elem)},windowEvent:function(t){"resize"===t.type&&this.elem.dispatchEvent(FEP.KeepInView.update),"scroll"===t.type&&this.elem.dispatchEvent(FEP.KeepInView.set)},anchorShifter:function(){if(this.options.offsetAnchor){var t=e("a[name]"),i=function(){var e=+new Date;do{var s=t.shift();void 0!==t[0]&&$(s).css({position:"relative",display:"block",top:"-"+this.box.height+"px"})}while(void 0!==t[0]&&50>+new Date-e);void 0!==t[0]&&setTimeout(i,0)};i()}},init:function(t){this.box=n.call(this),this.options.zindex=getComputedStyle(this.stickyElem).zIndex,this.options.cloned?(this.elem=this.stickyElem.cloneNode(!0),this.stickyElem.parentNode.insertBefore(this.elem,this.stickyElem),o(this.elem,this.namespace+"-cloned"),o(this.stickyElem,this.namespace+"-original")):this.elem=this.stickyElem,this.elem.id=this.namespace+"_"+this.index,this.position=getComputedStyle(this.stickyElem).position,this.elem.addEventListener("update",this.staySticky.bind(this),!0),this.elem.addEventListener("unstick",this.killSticky.bind(this),!0),this.elem.addEventListener("set",this.setElemRequest.bind(this),!0),window.addEventListener("resize",this.windowEvent.bind(this),!1),window.addEventListener("scroll",this.windowEvent.bind(this),!1),this.elem.dispatchEvent(FEP.KeepInView.set),this.anchorShifter(),"function"==typeof t&&t(this)}}});